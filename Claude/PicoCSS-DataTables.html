<!DOCTYPE html>
<html data-theme="light">
<head>
  <title>DataTables Viewer</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@yohns/picocss@2.2.2/css/pico.min.css" />
  <style>
    .header-cell {
      cursor: pointer;
      user-select: none;
      position: relative;
    }
    .header-cell:hover {
      background: var(--secondary-hover);
    }
    .sort-indicator::after {
      content: '↕️';
      margin-left: 5px;
    }
    .sort-asc::after {
      content: '↑';
    }
    .sort-desc::after {
      content: '↓';
    }
    .column-toggle-menu {
      position: absolute;
      background: var(--background-color);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      padding: 1rem;
      z-index: 1000;
      min-width: 200px;
    }
    .hidden {
      display: none;
    }
    .table-controls {
      display: flex;
      gap: 1rem;
      align-items: center;
      margin-bottom: 1rem;
    }
    .table-controls input[type="search"] {
      margin: 0;
    }
    .pagination {
      display: flex;
      gap: 1rem;
      align-items: center;
      margin-top: 1rem;
    }
    tfoot input {
      width: 100%;
      margin: 0;
      padding: 0.25rem;
    }
    tfoot select {
      width: 100%;
      margin: 0;
      padding: 0.25rem;
    }
    .loading {
      text-align: center;
      padding: 2rem;
    }
  </style>
</head>
<body>
  <main class="container">
    <h1>DataTables Viewer</h1>
    
    <div id="tableControls" class="table-controls">
      <div style="flex-grow: 1;">
        <input type="search" id="globalSearch" placeholder="Search all columns...">
      </div>
      <div>
        <select id="rowsPerPage">
          <option value="5">5 rows</option>
          <option value="10">10 rows</option>
          <option value="25">25 rows</option>
          <option value="50">50 rows</option>
        </select>
      </div>
      <div>
        <button id="toggleColumnsBtn">Toggle Columns</button>
      </div>
    </div>

    <div id="columnToggleMenu" class="column-toggle-menu hidden"></div>
    <div id="tableContainer"></div>
  </main>

  <script>
    // Sample data for preview - replace with your actual data
    const sampleData = [
      { id: 1, name: "John Doe", date: "2024-01-01", status: "Active" },
      { id: 2, name: "Jane Smith", date: "2024-01-02", status: "Inactive" },
      { id: 3, name: "Bob Johnson", date: "2024-01-03", status: "Active" },
    ];

    class DataTableViewer {
      constructor(config) {
        this.config = {
          dataUrl: config.dataUrl,
          editEndpoint: config.editEndpoint || '',
          extraEditData: config.extraEditData || {},
          onEditSuccess: config.onEditSuccess || ((response) => console.log('Edit success:', response)),
          columns: config.columns || [],
          rowsPerPage: config.rowsPerPage || 10,
          container: config.container || document.getElementById('tableContainer')
        };
        
        this.data = [];
        this.filteredData = [];
        this.currentPage = 1;
        this.sortColumn = null;
        this.sortDirection = 'asc';
        this.columnSearchValues = {};
        this.globalSearchValue = '';
        this.hiddenColumns = new Set();
        
        this.init();
      }

      async init() {
        await this.loadData();
        this.setupControls();
        this.render();
      }

      async loadData() {
        this.config.container.innerHTML = '<div class="loading">Loading data...</div>';
        try {
          if (this.config.dataUrl) {
            const response = await fetch(this.config.dataUrl);
            this.data = await response.json();
          } else {
            // Use sample data for preview
            this.data = sampleData;
          }
          this.filteredData = [...this.data];
        } catch (error) {
          console.error('Error loading data:', error);
          this.config.container.innerHTML = '<div class="error">Error loading data</div>';
        }
      }

      setupControls() {
        // Global search
        document.getElementById('globalSearch').addEventListener('input', (e) => {
          this.globalSearchValue = e.target.value.toLowerCase();
          this.filterData();
          this.currentPage = 1;
          this.render();
        });

        // Rows per page
        document.getElementById('rowsPerPage').addEventListener('change', (e) => {
          this.config.rowsPerPage = parseInt(e.target.value);
          this.currentPage = 1;
          this.render();
        });

        // Column toggle menu
        const toggleBtn = document.getElementById('toggleColumnsBtn');
        const menu = document.getElementById('columnToggleMenu');
        
        toggleBtn.addEventListener('click', () => {
          menu.classList.toggle('hidden');
          menu.style.top = `${toggleBtn.offsetTop + toggleBtn.offsetHeight}px`;
          menu.style.left = `${toggleBtn.offsetLeft}px`;
          
          menu.innerHTML = this.config.columns.map(col => `
            <label>
              <input type="checkbox" 
                     ${!this.hiddenColumns.has(col.field) ? 'checked' : ''}
                     data-column="${col.field}">
              ${col.title}
            </label>
          `).join('');
        });

        menu.addEventListener('change', (e) => {
          if (e.target.matches('input[type="checkbox"]')) {
            const column = e.target.dataset.column;
            if (e.target.checked) {
              this.hiddenColumns.delete(column);
            } else {
              this.hiddenColumns.add(column);
            }
            this.render();
          }
        });

        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
          if (!menu.contains(e.target) && e.target !== toggleBtn) {
            menu.classList.add('hidden');
          }
        });
      }

      filterData() {
        this.filteredData = this.data.filter(row => {
          // Global search
          if (this.globalSearchValue) {
            const rowString = Object.values(row).join(' ').toLowerCase();
            if (!rowString.includes(this.globalSearchValue)) return false;
          }

          // Column-specific search
          return Object.entries(this.columnSearchValues).every(([field, searchValue]) => {
            if (!searchValue) return true;
            const value = String(row[field]).toLowerCase();
            return value.includes(searchValue);
          });
        });
      }

      sortData(column) {
        if (this.sortColumn === column) {
          this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
          this.sortColumn = column;
          this.sortDirection = 'asc';
        }

        const col = this.config.columns.find(c => c.field === column);
        
        this.filteredData.sort((a, b) => {
          let valA = a[column];
          let valB = b[column];

          if (col.type === 'date') {
            valA = new Date(valA);
            valB = new Date(valB);
          }

          if (valA < valB) return this.sortDirection === 'asc' ? -1 : 1;
          if (valA > valB) return this.sortDirection === 'asc' ? 1 : -1;
          return 0;
        });

        this.render();
      }

      async handleEdit(rowIndex, row) {
        try {
          const response = await fetch(this.config.editEndpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              ...row,
              ...this.config.extraEditData
            })
          });

          if (!response.ok) throw new Error('Edit failed');
          
          const result = await response.json();
          this.config.onEditSuccess(result);
          
          // Update local data
          Object.assign(this.data[rowIndex], row);
          this.filterData();
          this.render();
          
        } catch (error) {
          console.error('Error saving edit:', error);
          alert('Failed to save changes');
        }
      }

      render() {
        const visibleColumns = this.config.columns.filter(col => !this.hiddenColumns.has(col.field));
        const startIndex = (this.currentPage - 1) * this.config.rowsPerPage;
        const endIndex = startIndex + this.config.rowsPerPage;
        const pageData = this.filteredData.slice(startIndex, endIndex);

        this.config.container.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>Edit</th>
                ${visibleColumns.map(col => `
                  <th class="header-cell ${this.sortColumn === col.field ? `sort-${this.sortDirection}` : 'sort-indicator'}"
                      data-column="${col.field}">
                    ${col.title}
                  </th>
                `).join('')}
              </tr>
            </thead>
            <tbody>
              ${pageData.map((row, idx) => `
                <tr id="row-${idx}">
                  <td>
                    <button class="edit-btn" data-row="${idx}">Edit</button>
                  </td>
                  ${visibleColumns.map(col => `
                    <td class="data-cell" data-column="${col.field}">${row[col.field]}</td>
                  `).join('')}
                </tr>
              `).join('')}
            </tbody>
            <tfoot>
              <tr>
                <td></td>
                ${visibleColumns.map(col => `
                  <td>
                    ${col.searchType === 'select' ? 
                      `<select class="column-search" data-column="${col.field}">
                        <option value="">All</option>
                        ${[...new Set(this.data.map(item => item[col.field]))].map(value => 
                          `<option value="${value}" ${this.columnSearchValues[col.field] === value ? 'selected' : ''}>${value}</option>`
                        ).join('')}
                      </select>` :
                      `<input type="search" class="column-search" data-column="${col.field}" 
                              value="${this.columnSearchValues[col.field] || ''}" 
                              placeholder="Search ${col.title}...">`
                    }
                  </td>
                `).join('')}
              </tr>
            </tfoot>
          </table>
          <div class="pagination">
            <button ${this.currentPage === 1 ? 'disabled' : ''} onclick="dataTable.currentPage--; dataTable.render()">Previous</button>
            <span>Page ${this.currentPage} of ${Math.ceil(this.filteredData.length / this.config.rowsPerPage)}</span>
            <button ${this.currentPage === Math.ceil(this.filteredData.length / this.config.rowsPerPage) ? 'disabled' : ''} 
                    onclick="dataTable.currentPage++; dataTable.render()">Next</button>
          </div>
        `;

        // Setup column search
        this.config.container.querySelectorAll('.column-search').forEach(input => {
          input.addEventListener('input', (e) => {
            const column = e.target.dataset.column;
            this.columnSearchValues[column] = e.target.value.toLowerCase();
            this.filterData();
            this.currentPage = 1;
            this.render();
          });
        });

        // Setup sorting
        this.config.container.querySelectorAll('.header-cell').forEach(header => {
          header.addEventListener('click', () => {
            const column = header.dataset.column;
            this.sortData(column);
          });
        });

        // Setup edit buttons
        this.config.container.querySelectorAll('.edit-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const rowIndex = parseInt(btn.dataset.row);
            const row = pageData[rowIndex];
            
            const tr = document.getElementById(`row-${rowIndex}`);
            const originalContent = tr.innerHTML;
            
            tr.innerHTML = `
              <td>
                <button class="save-btn">Save</button>
                <button class="cancel-btn">Cancel</button>
              </td>
              ${visibleColumns.map(col => `
                <td>
                  <input type="text" value="${row[col.field]}" data-field="${col.field}">
                </td>
              `).join('')}
            `;

            tr.querySelector('.save-btn').addEventListener('click', () => {
              const updatedRow = {...row};
              tr.querySelectorAll('input[data-field]').forEach(input => {
                updatedRow[input.dataset.field] = input.value;
              });
              this.handleEdit(rowIndex, updatedRow);
            });

            tr.querySelector('.cancel-btn').addEventListener('click', () => {
              tr.innerHTML = originalContent;
            });
          });
        });
      }
    }

    // Initialize with sample data
    const dataTable = new DataTableViewer({
      columns: [
        { field: 'id', title: 'ID', searchType: 'text' },
        { field: 'name', title: 'Name', searchType: 'text' },
        { field: 'date', title: 'Date', type: 'date', searchType: 'text' },
        { field: 'status', title: 'Status', searchType: 'select' }
      ]
    });
  </script>
</body>
</html>
